<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Organic Hunter âœ¨</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        :root { --main-green: #2e7d32; --accent-orange: #f39c12; }
        body { margin: 0; padding: 0; height: 100dvh; font-family: 'Helvetica Neue', Arial, sans-serif; background: #f4f7f4; overflow: hidden; }
        
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; }
        
        /* ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ã‚¯ï¼ˆå¥¥æ§˜ãŒæ“ä½œã—ã‚„ã™ã„ã‚ˆã†å¯æ„›ãï¼‰ */
        .crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; pointer-events: none; color: var(--main-green);
            font-size: 40px; text-shadow: 0 0 10px white;
        }

        .ui-panel {
            position: fixed; bottom: 30px; left: 0; right: 0;
            z-index: 3000; text-align: center; pointer-events: none;
        }
        
        .scan-btn {
            background: linear-gradient(135deg, #43a047, #2e7d32);
            color: white; border: none; padding: 16px 40px;
            border-radius: 50px; font-weight: bold; font-size: 1.2rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); 
            cursor: pointer; pointer-events: auto;
            transition: all 0.2s; -webkit-appearance: none;
        }
        .scan-btn:active { transform: scale(0.92); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        #status {
            background: rgba(255,255,255,0.95); margin-top: 15px;
            padding: 8px 20px; border-radius: 30px; font-size: 0.9rem;
            display: inline-block; color: #333; font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .leaflet-popup-content-wrapper { border-radius: 15px; padding: 5px; }
        .shop-card { text-align: center; min-width: 180px; }
        .shop-card b { font-size: 1.2rem; color: var(--main-green); display: block; margin-bottom: 10px; }
        .btn-group { display: flex; flex-direction: column; gap: 8px; }
        .info-btn { 
            background: #e3f2fd; color: #1976d2; padding: 8px; 
            text-decoration: none; border-radius: 8px; font-size: 0.8rem; font-weight: bold;
        }
        .nav-btn { 
            background: var(--accent-orange); color: white; padding: 10px; 
            text-decoration: none; border-radius: 8px; font-size: 0.9rem; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="map">
    <div class="crosshair">âœ¨</div>
</div>

<div class="ui-panel">
    <button class="scan-btn" onclick="scanAtCenter()">ğŸŒ¿ ç´ æ•µãªåº—ã‚’æ¢ã™</button><br>
    <div id="status">åœ°å›³ã‚’å‹•ã‹ã—ã¦ã€Œâœ¨ã€ã‚’åˆã‚ã›ã¦ã­</div>
</div>

<script>
    // 1. åœ°å›³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    var map = L.map('map', { zoomControl: false }).setView([34.811, 135.341], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // 2. æœ€åˆã«ç¾åœ¨åœ°ã¸å„ªã—ãç§»å‹•
    navigator.geolocation.getCurrentPosition(pos => {
        map.flyTo([pos.coords.latitude, pos.coords.longitude], 15, { duration: 2 });
    });

    // 3. ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œï¼ˆOverpass API å†—é•·åŒ–å¯¾å¿œï¼‰
    async function scanAtCenter() {
        const status = document.getElementById('status');
        const center = map.getCenter();
        status.innerText = "æ¢ã—å›ã£ã¦ã„ã¾ã™...ğŸ”­";

        // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã€Œå¥¥æ§˜å¥½ã¿ã€ã«ç‰¹åŒ–
        const query = `[out:json][timeout:20];(
            node["shop"~"organic|health_food|confectionery"](around:3000,${center.lat},${center.lng});
            node["name"~"æœ‰æ©Ÿ|è‡ªç„¶é£Ÿå“|ç”£ç›´|ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯|ç„¡æ·»åŠ |è¾²åœ’"](around:3000,${center.lat},${center.lng});
        );out;`;
        
        try {
            const res = await fetch(`https://overpass.kumi.systems/api/interpreter?data=${encodeURIComponent(query)}`);
            const data = await res.json();
            
            if (!data.elements || data.elements.length === 0) {
                status.innerText = "ã“ã®è¾ºã«ã¯ã¾ã è¦‹ã¤ã‹ã‚‰ãªã„ã¿ãŸã„...ğŸ˜¢";
                return;
            }

            status.innerText = "è¦‹ã¤ã‘ã¾ã—ãŸï¼ â” " + data.elements.length + "ä»¶";
            
            data.elements.forEach(el => {
                const name = el.tags.name || "ç´ æ•µãªãŠåº—";
                const googleSearch = `https://www.google.com/search?q=${encodeURIComponent(name)}+ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯+å…¬å¼ã‚µã‚¤ãƒˆ`;
                const googleImg = `https://www.google.com/search?q=${encodeURIComponent(name)}+åº—å†…+å†™çœŸ&tbm=isch`;

                const greenIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                });

                const content = `
                    <div class="shop-card">
                        <b>${name}</b>
                        <div class="btn-group">
                            <a href="${googleSearch}" target="_blank" class="info-btn">ğŸ” å…¬å¼HPãƒ»å£ã‚³ãƒŸã‚’è¦‹ã‚‹</a>
                            <a href="${googleImg}" target="_blank" class="info-btn">ğŸ“¸ ãŠåº—ã®é›°å›²æ°—ã‚’è¦‹ã‚‹</a>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${el.lat},${el.lon}" target="_blank" class="nav-btn">ğŸš— ã“ã“ã¸è¡Œã</a>
                        </div>
                    </div>
                `;

                L.marker([el.lat, el.lon], {icon: greenIcon}).addTo(map).bindPopup(content);
            });
        } catch (e) {
            status.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã­";
        }
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Organic Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #map { width: 100%; height: 100%; position: absolute; top: 0; bottom: 0; background: #eee; }
        .ui-container {
            position: fixed; bottom: 30px; left: 0; right: 0;
            z-index: 9999; text-align: center;
        }
        #scan-btn {
            background: #2e7d32; color: white; border: none; padding: 18px 0;
            width: 85%; max-width: 350px; border-radius: 50px; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); cursor: pointer; -webkit-appearance: none;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div class="ui-container">
    <button id="scan-btn" onclick="initiateScan()">ğŸŒ¿ ç¾åœ¨åœ°å‘¨è¾ºã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
</div>

<script>
    // 2. åœ°å›³ã®åˆæœŸåŒ–ã‚’ã€Œå®‰å…¨ãªå ´æ‰€ã€ã§å®Ÿè¡Œ
    var map;
    try {
        map = L.map('map').setView([35.68, 139.76], 5);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OSM'
        }).addTo(map);
    } catch (e) {
        alert("åœ°å›³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
    }

    function initiateScan() {
        if (!navigator.geolocation) {
            alert("ãŠä½¿ã„ã®ç«¯æœ«ã¯GPSã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
            return;
        }

        navigator.geolocation.getCurrentPosition(function(pos) {
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;
            
            map.setView([lat, lon], 15);
            L.marker([lat, lon]).addTo(map).bindPopup("ç¾åœ¨åœ°").openPopup();
            
            fetchData(lat, lon);
        }, function(err) {
            alert("GPSã‚¨ãƒ©ãƒ¼(" + err.code + "): " + err.message);
        }, { enableHighAccuracy: true, timeout: 10000 });
    }

    function fetchData(lat, lon) {
        var query = '[out:json][timeout:20];(node["shop"~"organic|health_food"](around:5000,' + lat + ',' + lon + ');node["name"~"æœ‰æ©Ÿ|è‡ªç„¶é£Ÿå“|ç”£ç›´|ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯"](around:5000,' + lat + ',' + lon + '););out;';
        var url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
        
        fetch(url).then(function(res) { return res.json(); }).then(function(data) {
            if (data.elements.length === 0) {
                alert("å‘¨è¾ºã«ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯åº—ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                return;
            }
            data.elements.forEach(function(el) {
                var greenIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                });
                L.marker([el.lat, el.lon], {icon: greenIcon}).addTo(map)
                    .bindPopup("<b>" + (el.tags.name || "è‡ªç„¶é£Ÿå“åº—") + "</b><br><br><a href='https://www.google.com/maps/dir/?api=1&destination=" + el.lat + "," + el.lon + "' target='_blank'>ãƒŠãƒ“é–‹å§‹</a>");
            });
        }).catch(function() {
            alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        });
    }
</script>
</body>
</html>

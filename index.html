<script>
    // ...（前段のコードは同じ）...

    async function executeSearch(lat, lon) {
        const status = document.getElementById('status');
        status.innerText = "サーバーに接続中（1/2）...";

        const query = `[out:json][timeout:15];(node["shop"~"organic|health_food"](around:5000,${lat},${lon});node["name"~"有機|自然食品|産直|オーガニック"](around:5000,${lat},${lon}););out;`;
        const encodedQuery = encodeURIComponent(query);
        
        // 予備サーバーのリスト（冗長化）
        const servers = [
            "https://overpass-api.de/api/interpreter",
            "https://overpass.kumi.systems/api/interpreter",
            "https://overpass.nchc.org.tw/api/interpreter"
        ];

        for (const baseUrl of servers) {
            try {
                const response = await fetch(`${baseUrl}?data=${encodedQuery}`);
                if (!response.ok) throw new Error();
                
                const data = await response.json();
                renderMarkers(data); // 成功したら表示処理へ
                return; // 完了したら終了
            } catch (e) {
                status.innerText = "サーバーを切り替えて再試行中...";
                continue; // 次のサーバーを試す
            }
        }
        status.innerText = "全サーバーが応答しません。時間を置いて試してください。";
    }

    function renderMarkers(data) {
        const status = document.getElementById('status');
        if (!data.elements || data.elements.length === 0) {
            status.innerText = "この付近には見つかりませんでした";
            return;
        }
        status.innerText = `${data.elements.length}軒の店舗を発見！`;
        data.elements.forEach(el => {
            const name = el.tags.name || "自然食品店";
            const greenIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
            });
            L.marker([el.lat, el.lon], {icon: greenIcon}).addTo(map)
                .bindPopup(`<b>${name}</b><br><br><a href="https://www.google.com/maps/dir/?api=1&destination=${el.lat},${el.lon}" target="_blank" style="background:#f39c12;color:white;padding:8px 12px;text-decoration:none;border-radius:5px;display:inline-block;">ここへ行く(ナビ)</a>`);
        });
    }
</script>

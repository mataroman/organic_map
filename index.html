<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Organic Hunter ‚ú®</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root { --main-green: #2e7d32; --stop-red: #c62828; }
        body { margin: 0; padding: 0; height: 100dvh; font-family: sans-serif; background: #000; color: #fff; }
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; }
        .dog-banner { position: fixed; top: 15px; left: 15px; z-index: 4000; background: white; padding: 5px; border-radius: 50px; display: flex; align-items: center; border: 2px solid var(--main-green); }
        .dog-photo { width: 50px; height: 50px; border-radius: 50%; }
        .dog-msg { padding: 0 15px; font-weight: bold; color: #333; font-size: 0.85rem; }
        .ui { position: fixed; bottom: 30px; left: 0; right: 0; z-index: 3000; text-align: center; }
        .btn { color: white; border: none; padding: 18px 45px; border-radius: 50px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        .scan-btn { background: var(--main-green); }
        #status { background: rgba(255,255,255,0.95); padding: 8px 20px; border-radius: 25px; font-size: 0.85rem; color: #333; display: inline-block; margin-bottom: 5px; }
        .mataro-pin { width: 50px !important; height: 50px !important; border: 3px solid #fff; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>

<div class="dog-banner">
    <img src="mataro.jpg" class="dog-photo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616408.png'">
    <div id="dog-msg-text" class="dog-msg">Ê∫ñÂÇô„Åä„Å£„Åë„ÉºÔºü</div>
</div>

<div id="map"></div>

<div class="ui">
    <div id="status">Ë®∫Êñ≠„ÇíÈñãÂßã„Åô„Çã„Åï</div>
    <button id="action-btn" class="btn scan-btn" onclick="startScan()">üåø „Çπ„Ç≠„É£„É≥ÈñãÂßã</button>
</div>

<script>
    // „ÄêÁÇπÊ§ú„Äë„Åì„Åì„Åå„ÅÇ„Å™„Åü„ÅÆÊ≠£„Åó„ÅÑID„Åß„ÅÇ„Çã„Åì„Å®„ÇíÂÜçÁ¢∫Ë™ç„Åï
    const appid = 'dmVyPTIwMjUwNyZpZD1YcTQ2bjJjcU1rJmhhc2g9TlRRNVpURTJZakEyTVRKbVl6TTVZUQ';
    
    const map = L.map('map', { zoomControl: false }).setView([34.811, 135.341], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];

    function startScan() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        document.getElementById('status').innerText = "ÈÄö‰ø°„ÉÜ„Çπ„Éà‰∏≠„Åï...";

        const center = map.getCenter();
        
        // 1. ÈÄö‰ø°„Ç®„É©„Éº„ÇíÊçïÊçâ„Åô„Çã„Åü„ÇÅ„ÅÆscript„Çø„Ç∞‰ΩúÊàê
        const script = document.createElement('script');
        
        // ÊúÄ„ÇÇ„ÄåÈÄö„Çä„ÇÑ„Åô„ÅÑ„ÄçÊúÄÂ∞èÊßãÊàê„ÅÆURL
        const url = `https://map.yahooapis.jp/search/local/V1/localSearch?appid=${appid}&lat=${center.lat}&lon=${center.lng}&dist=10&output=json&callback=handleResponse`;

        script.src = url;
        
        // „ÄêÈáçË¶Å„Äë„ÇÇ„ÅóË™≠„ÅøËæº„ÅøËá™‰Ωì„Å´Â§±Êïó„Åó„Åü„ÇâÔºà403„Ç®„É©„Éº„Å™„Å©ÔºâÂç≥Â∫ß„Å´Ë°®Á§∫„Åï
        script.onerror = () => {
            document.getElementById('status').innerText = "„Äê„Ç®„É©„Éº„Äë„Çµ„Éº„Éê„Éº„Å´ÊãíÁµ∂„Åï„Çå„Åü„ÅïÔºÅID„Åã„Éâ„É°„Ç§„É≥„ÅåÈÅï„ÅÜ„Åï";
            document.getElementById('dog-msg-text').innerText = "Èºª„ÅåË©∞„Åæ„Å£„Åü„Åø„Åü„ÅÑ„Å†„Åï...";
        };

        document.body.appendChild(script);
    }

    window.handleResponse = function(data) {
        // „ÇÇ„Åó„Åì„Åì„ÅåÂëº„Å∞„Çå„Åü„Å™„Çâ„ÄÅÈÄö‰ø°„ÅØÊàêÂäü„Åó„Å¶„ÅÑ„Çã„Åï
        if (data.Error) {
            document.getElementById('status').innerText = "API„Ç®„É©„Éº: " + data.Error.Message;
            return;
        }

        if (!data.Feature || data.Feature.length === 0) {
            document.getElementById('status').innerText = "Â∫ó„Åå0‰ª∂„Å†„Åï„ÄÇ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÁ©∫„Å´„Åó„Å¶„ÇÇÂá∫„Å™„ÅÑ„Åï";
            return;
        }

        data.Feature.forEach((f) => {
            const coords = f.Geometry.Coordinates.split(',');
            const m = L.marker([coords[1], coords[0]], {
                icon: L.icon({ iconUrl: 'mataro.jpg', className: 'mataro-pin', iconSize: [50, 50], iconAnchor:

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Organic Hunter ‚ú®</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root { --main-green: #2e7d32; --stop-red: #c62828; }
        body { margin: 0; padding: 0; height: 100dvh; font-family: sans-serif; overflow: hidden; background: #000; }
        
        /* Âú∞Âõ≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; transition: opacity 0.3s, filter 0.3s; }
        /* „Çπ„Ç≠„É£„É≥‰∏≠„ÅÆ„É≠„ÉÉ„ÇØÁä∂ÊÖã„ÅÆË¶ã„ÅüÁõÆ */
        .map-locked { opacity: 0.7; filter: grayscale(0.5) blur(1px); pointer-events: none; }
        
        .crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; pointer-events: none; font-size: 32px; filter: drop-shadow(0 0 2px white);
        }

        .ui { position: fixed; bottom: 30px; left: 0; right: 0; z-index: 3000; text-align: center; }
        
        .btn {
            color: white; border: none; padding: 16px 40px;
            border-radius: 50px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer; min-width: 220px; transition: 0.3s; -webkit-appearance: none;
        }
        .scan-btn { background: var(--main-green); }
        .stop-btn { background: var(--stop-red); }

        #progress-container {
            width: 80%; max-width: 300px; height: 10px; background: rgba(255,255,255,0.8);
            margin: 10px auto; border-radius: 10px; overflow: hidden; display: none;
        }
        #progress-bar { width: 0%; height: 100%; background: var(--main-green); transition: width 0.1s; }

        #status {
            background: rgba(255,255,255,0.95); padding: 8px 20px;
            border-radius: 25px; font-size: 0.9rem; display: inline-block; font-weight: bold; margin-bottom: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .popup-card { text-align: center; padding: 5px; }
        .link-btn {
            display: block; margin-top: 8px; padding: 10px; text-decoration: none;
            border-radius: 5px; font-weight: bold; font-size: 0.9rem;
        }
        .hp-btn { background: #e3f2fd; color: #1976d2; }
        .nav-btn { background: #f39c12; color: white; }
    </style>
</head>
<body>

<div id="map"><div class="crosshair">‚ú®</div></div>

<div class="ui">
    <div id="status">„Äå‚ú®„Äç„ÇíÂêà„Çè„Åõ„Å¶„Çπ„Ç≠„É£„É≥ÔºÅ</div>
    <div id="progress-container"><div id="progress-bar"></div></div>
    <button id="action-btn" class="btn scan-btn" onclick="toggleScan()">üåø „Çπ„Ç≠„É£„É≥ÈñãÂßã</button>
</div>

<script>
    const appid = 'dj00aiZpPVhxNDZuMmNxTWtNayZzPWNvbnN1bWVyc2VjcmV0Jng9NTI-';
    let isScanning = false;

    // Âú∞Âõ≥ÂàùÊúüÂåñ
    var map = L.map('map', { zoomControl: false }).setView([34.811, 135.341], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    navigator.geolocation.getCurrentPosition(pos => {
        map.flyTo([pos.coords.latitude, pos.coords.longitude], 15);
    });

    function toggleScan() {
        if (isScanning) {
            stopScan("„Çπ„Ç≠„É£„É≥„Çí‰∏≠Ê≠¢„Åó„Åæ„Åó„Åü");
        } else {
            startScan();
        }
    }

    function startScan() {
        isScanning = true;
        
        // --- Âú∞Âõ≥„ÅÆÊìç‰Ωú„Çí„É≠„ÉÉ„ÇØ ---
        map.dragging.disable();
        map.touchZoom.disable();
        map.doubleClickZoom.disable();
        map.scrollWheelZoom.disable();
        document.getElementById('map').classList.add('map-locked');

        const btn = document.getElementById('action-btn');
        const status = document.getElementById('status');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');

        btn.innerText = "üõë „Çπ„Ç≠„É£„É≥ÂÅúÊ≠¢";
        btn.className = "btn stop-btn";
        status.innerText = "„Ç∑„Éß„ÉÉ„Éó„ÇíÊé¢Á¥¢‰∏≠Ôºà„É≠„ÉÉ„ÇØ‰∏≠Ôºâ";
        progressContainer.style.display = "block";
        progressBar.style.width = "0%";

        let progress = 0;
        const interval = setInterval(() => {
            if (!isScanning) { clearInterval(interval); return; }
            if (progress < 90) { progress += 3; progressBar.style.width = progress + "%"; }
        }, 100);

        const center = map.getCenter();
        const query = encodeURIComponent('„Ç™„Éº„Ç¨„Éã„ÉÉ„ÇØ Ëá™ÁÑ∂È£üÂìÅ ÁÑ°Ê∑ªÂä† Áî£Áõ¥');
        const url = `https://map.yahooapis.jp/search/local/V1/localSearch?appid=${appid}&lat=${center.lat}&lon=${center.lng}&dist=3&query=${query}&output=json&results=20&callback=handleResponse`;

        const script = document.createElement('script');
        script.id = "yahoo-script";
        script.src = url;
        document.body.appendChild(script);
    }

    function stopScan(msg) {
        isScanning = false;
        
        // --- Âú∞Âõ≥„ÅÆÊìç‰Ωú„É≠„ÉÉ„ÇØ„ÇíËß£Èô§ ---
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
        map.scrollWheelZoom.enable();
        document.getElementById('map').classList.remove('map-locked');

        const btn = document.getElementById('action-btn');
        const status = document.getElementById('status');
        const progressContainer = document.getElementById('progress-container');
        
        btn.innerText = "üåø „Çπ„Ç≠„É£„É≥ÈñãÂßã";
        btn.className = "btn scan-btn";
        status.innerText = msg;
        progressContainer.style.display = "none";

        const script = document.getElementById('yahoo-script');
        if (script) script.remove();
    }

    window.handleResponse = function(data) {
        if (!isScanning) return;
        
        document.getElementById('progress-bar').style.width = "100%";

        setTimeout(() => {
            if (!data.Feature || data.Feature.length === 0) {
                stopScan("Ëøë„Åè„Å´Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü üò¢");
                return;
            }

            data.Feature.forEach(f => {
                const coords = f.Geometry.Coordinates.split(',');
                const name = f.Name;
                const siteUrl = f.Property.Detail.PcSiteUrl || `https://www.google.com/search?q=${encodeURIComponent(name)}`;

                const content = `
                    <div class="popup-card">
                        <b style="color:#2e7d32;">${name}</b>
                        <a href="${siteUrl}" target="_blank" class="link-btn hp-btn">üåê ÂÖ¨Âºè„Çµ„Ç§„Éà„ÉªË©≥Á¥∞</a>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${coords[1]},${coords[0]}" target="_blank" class="link-btn nav-btn">üöó „Åì„Åì„Å∏Ë°å„Åè</a>
                    </div>
                `;

                const icon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                });

                L.marker([coords[1], coords[0]], {icon: icon}).addTo(map).bindPopup(content);
            });

            stopScan(data.Count + "‰ª∂Ë¶ã„Å§„Åã„Çä„Åæ„Åó„ÅüÔºÅ");
        }, 600);
    };
</script>
</body>
</html>

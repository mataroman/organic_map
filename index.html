<script>
    let firstScan = true; // 初回判定用フラグ

    function searchOrganic() {
        const status = document.getElementById('status');
        
        // 初回だけGPSで現在地を取得、2回目以降は「今見ている地図の中心」を基準にする
        if (firstScan) {
            status.innerText = "現在地を特定中...";
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude: lat, longitude: lon } = pos.coords;
                map.setView([lat, lon], 14);
                L.marker([lat, lon]).addTo(map).bindPopup("あなたの現在地").openPopup();
                firstScan = false;
                executeSearch(lat, lon); // 検索実行へ
            }, (err) => {
                status.innerText = "GPSエラー: 許可を確認してください";
            });
        } else {
            // 2回目以降は地図の中心座標を取得
            const center = map.getCenter();
            executeSearch(center.lat, center.lng);
        }
    }

    function executeSearch(lat, lon) {
        const status = document.getElementById('status');
        status.innerText = "このエリアの店舗を検索中...";

        const query = `[out:json][timeout:25];(node["shop"~"organic|health_food"](around:3000,${lat},${lon});node["name"~"有機|自然食品|産直|オーガニック"](around:3000,${lat},${lon}););out;`;
        
        // 安定性の高いサーバーを使用
        fetch(`https://overpass.kumi.systems/api/interpreter?data=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if (data.elements.length === 0) {
                status.innerText = "この付近には見つかりませんでした";
                return;
            }
            status.innerText = `${data.elements.length}軒見つかりました！`;
            
            data.elements.forEach(el => {
                const greenIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    iconSize: [25, 41], iconAnchor: [12, 41]
                });
                L.marker([el.lat, el.lon], {icon: greenIcon}).addTo(map)
                    .bindPopup(`<b>${el.tags.name || "自然食品店"}</b><br><br><a href="http://maps.google.com/?q=${el.lat},${el.lon}" target="_blank" style="background:#f39c12;color:white;padding:5px 10px;text-decoration:none;border-radius:3px;">ナビ</a>`);
            });
        })
        .catch(() => status.innerText = "通信エラー。もう一度押してください。");
    }
</script>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organic Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .control-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 400px; text-align: center;
        }
        #scan-btn {
            background: #2e7d32; color: white; border: none; padding: 18px 0;
            width: 100%; border-radius: 50px; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; transition: 0.2s;
        }
        #scan-btn:active { transform: scale(0.95); background: #1b5e20; }
        #status {
            margin-top: 10px; background: rgba(255,255,255,0.9);
            padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; display: inline-block;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div class="control-panel">
    <button id="scan-btn" onclick="startScan()">ğŸ“ å‘¨è¾ºã®ã‚·ãƒ§ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    <div id="status">æº–å‚™å®Œäº†</div>
</div>

<script>
    // æ—¥æœ¬å…¨ä½“ã‚’è¡¨ç¤ºã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ
    const map = L.map('map').setView([35.68, 139.76], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function startScan() {
        const status = document.getElementById('status');
        const btn = document.getElementById('scan-btn');
        
        status.innerText = "ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...";
        btn.disabled = true;

        navigator.geolocation.getCurrentPosition(function(pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            
            map.setView([lat, lon], 14);
            L.marker([lat, lon]).addTo(map).bindPopup("<b>ã‚ãªãŸã®ç¾åœ¨åœ°</b>").openPopup();

            status.innerText = "å‘¨è¾º5kmã®ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯åº—ã‚’æ¤œç´¢ä¸­...";

            // ç„¡æ–™ã®åœ°å›³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(Overpass API)ã‹ã‚‰åº—èˆ—ã‚’æŠ½å‡º
            const query = `[out:json];node["shop"~"organic|health_food"](around:5000,${lat},${lon});out;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    btn.disabled = false;
                    if (data.elements.length === 0) {
                        status.innerText = "ä»˜è¿‘ã«ç™»éŒ²åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
                        return;
                    }
                    
                    status.innerText = `${data.elements.length}è»’ã®åº—èˆ—ã‚’ç™ºè¦‹ï¼`;
                    
                    data.elements.forEach(shop => {
                        const name = shop.tags.name || "æœ‰æ©Ÿè£½å“å–ã‚Šæ‰±ã„åº—";
                        const shopLat = shop.lat;
                        const shopLon = shop.lon;
                        
                        // ç·‘è‰²ã®ãƒ”ãƒ³ã‚’ä½œæˆ
                        const greenPin = L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                        });

                        L.marker([shopLat, shopLon], {icon: greenPin}).addTo(map)
                            .bindPopup(`
                                <div style="text-align:center;">
                                    <b>${name}</b><br><br>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${shopLat},${shopLon}" 
                                       target="_blank" 
                                       style="background:#f39c12;color:white;padding:8px 12px;text-decoration:none;border-radius:5px;font-size:12px;">
                                       Googleãƒãƒƒãƒ—ã§ãƒŠãƒ“
                                    </a>
                                </div>
                            `);
                    });
                })
                .catch(err => {
                    status.innerText = "æ¤œç´¢ã‚¨ãƒ©ãƒ¼ï¼ˆã‚µãƒ¼ãƒãƒ¼æ··é›‘ä¸­ï¼‰";
                    btn.disabled = false;
                });

        }, function(err) {
            status.innerText = "GPSã‚¨ãƒ©ãƒ¼: è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„";
            btn.disabled = false;
        }, { enableHighAccuracy: true });
    }
</script>
</body>
</html>

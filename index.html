<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Organic Map Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        #map { flex-grow: 1; width: 100vw; }
        .ui-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 400px; text-align: center;
        }
        #scan-btn {
            background: #2e7d32; color: white; border: none; padding: 18px;
            width: 100%; border-radius: 50px; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer;
        }
        #scan-btn:active { background: #1b5e20; transform: scale(0.95); }
        #status {
            margin-top: 10px; background: rgba(255,255,255,0.9);
            padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; display: inline-block;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
    <button id="scan-btn" onclick="startScan()">ğŸŒ¿ ã“ã®ã‚¨ãƒªã‚¢ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    <div id="status">æº–å‚™å®Œäº†</div>
</div>

<script>
    // 1. åœ°å›³ã®åˆæœŸåŒ–
    const map = L.map('map').setView([34.81, 135.34], 14); // åˆæœŸä½ç½®ã‚’å®å¡šä»˜è¿‘ã«è¨­å®š
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let firstTime = true;

    // 2. ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
    function startScan() {
        const status = document.getElementById('status');
        if (firstTime) {
            status.innerText = "ç¾åœ¨åœ°ã‚’ç‰¹å®šä¸­...";
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                map.setView([lat, lon], 14);
                L.marker([lat, lon]).addTo(map).bindPopup("ç¾åœ¨åœ°").openPopup();
                firstTime = false;
                executeSearch(lat, lon);
            }, err => {
                status.innerText = "GPSã‚¨ãƒ©ãƒ¼ã€‚ä»Šã®åœ°å›³ã®ä¸­å¿ƒã§æ¤œç´¢ã—ã¾ã™ã€‚";
                firstTime = false;
                const center = map.getCenter();
                executeSearch(center.lat, center.lng);
            });
        } else {
            const center = map.getCenter();
            executeSearch(center.lat, center.lng);
        }
    }

    // 3. ã‚µãƒ¼ãƒãƒ¼ã¸åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’å•ã„åˆã‚ã›ã‚‹ï¼ˆå†—é•·åŒ–ï¼‰
    async function executeSearch(lat, lon) {
        const status = document.getElementById('status');
        status.innerText = "ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...";

        const query = `[out:json][timeout:15];(node["shop"~"organic|health

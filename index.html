<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Organic Hunter âœ¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root { --main-green: #2e7d32; --stop-red: #c62828; }
        body { margin: 0; padding: 0; height: 100dvh; font-family: sans-serif; overflow: hidden; background: #000; }
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; transition: 0.3s; }
        .map-locked { opacity: 0.8; filter: brightness(0.6); pointer-events: none; }
        .dog-banner {
            position: fixed; top: 15px; left: 15px; z-index: 4000;
            background: white; padding: 5px; border-radius: 50px;
            display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 2px solid var(--main-green);
        }
        .dog-photo { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .dog-msg { padding: 0 15px 0 10px; font-weight: bold; font-size: 0.85rem; color: #333; min-width: 140px; }
        .ui { position: fixed; bottom: 30px; left: 0; right: 0; z-index: 3000; text-align: center; }
        .btn { color: white; border: none; padding: 18px 45px; border-radius: 50px; font-weight: bold; font-size: 1.2rem; cursor: pointer; min-width: 240px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .scan-btn { background: var(--main-green); }
        .stop-btn { background: var(--stop-red); }
        #status { background: rgba(255,255,255,0.95); padding: 8px 20px; border-radius: 25px; font-size: 0.85rem; display: inline-block; font-weight: bold; margin-bottom: 5px; color: #333; }
        .mataro-pin { width: 50px !important; height: 50px !important; border: 3px solid #fff; border-radius: 50%; object-fit: cover; box-shadow: 0 3px 10px rgba(0,0,0,0.4); }
    </style>
</head>
<body>

<div class="dog-banner">
    <img src="mataro.jpg" class="dog-photo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616408.png'">
    <div id="dog-msg-text" class="dog-msg">æº–å‚™ãŠã£ã‘ãƒ¼ï¼Ÿ</div>
</div>

<div id="map"></div>

<div class="ui">
    <div id="status">ãƒãƒ¼å¤ªéƒã«ä»»ã›ã¦ãŠã‘ã•</div>
    <button id="action-btn" class="btn scan-btn" onclick="toggleScan()">ğŸŒ¿ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
</div>

<script>
    // Yahoo! Client ID
    const appid = 'dmVyPTIwMjUwNyZpZD1YcTQ2bjJjcU1rJmhhc2g9TlRRNVpURTJZakEyTVRKbVl6TTVZUQ';
    
    let isScanning = false;
    let searchCircle = null;
    let markers = [];

    // ãƒãƒ¼å¤ªéƒã®å°è©é›†ã•
    const startMsgs = [
        "ã„ã„åŒ‚ã„ãŒã—ã¦ããŸã•",
        "ã“ã®è¾ºã‚Šã‚’ã‚¯ãƒ³ã‚¯ãƒ³ã™ã‚‹ã•",
        "éƒ½å†…ã ã‚ã†ãŒã©ã“ã§ã‚‚å—…ãåˆ†ã‘ã‚‹ã•",
        "ã“ã®å ´æ‰€ã®ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ã‚’æ¢ã—ã¦ã¿ã‚‹ã•",
        "ãƒœãƒãƒœãƒå§‹ã‚ã‚‹ã•ã€‚é¼»ã¯åˆ©ãæ–¹ã•",
        "ã‚¯ãƒ³ã‚¯ãƒ³â€¦ãŠã€ã“ã®è¾ºã‚Šã¯æ€ªã—ã„ã•"
    ];

    // åœ°å›³ã®åˆæœŸè¨­å®šï¼ˆå®å¡šå¸‚ä»˜è¿‘ï¼‰
    const map = L.map('map', { zoomControl: false }).setView([34.811, 135.341], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function toggleScan() { 
        if (isScanning) { 
            stopScan("ã¾ãŸå¾Œã§ã•"); 
        } else { 
            startScan(); 
        } 
    }

    function startScan() {
        isScanning = true;
        // æ—¢å­˜ã®ãƒ”ãƒ³ã‚’æƒé™¤ã•
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        // ãƒ©ãƒ³ãƒ€ãƒ å°è©ã®ã‚»ãƒƒãƒˆã•
        const randomMsg = startMsgs[Math.floor(Math.random() * startMsgs.length)];
        document.getElementById('dog-msg-text').innerText = randomMsg;
        document.getElementById('status').innerText = "åºƒåŸŸã‚¹ã‚­ãƒ£ãƒ³ä¸­ã•ã€‚å°‘ã—å¾…ã£ã¦ã¦ãã‚Œã•";

        document.getElementById('map').classList.add('map-locked');
        document.getElementById('action-btn').innerText = "ğŸ›‘ åœæ­¢ã™ã‚‹ã•";
        document.getElementById('action-btn').className = "btn stop-btn";

        // åœ°å›³ã®ä¸­å¿ƒã‚’å–å¾—ã—ã¦ã€ã‚¹ã‚­ãƒ£ãƒ³å††ã‚’æç”»ã•ï¼ˆåŠå¾„10kmï¼‰
        const center = map.getCenter();
        if (searchCircle) map.removeLayer(searchCircle);
        searchCircle = L.circle(center, {
            radius: 10000, color: '#2e7d32', fillColor: '#2e7d32', fillOpacity: 0.15, weight: 2
        }).addTo(map);

        // ã€ãƒ—ãƒ­ä»•æ§˜ã‚¯ã‚¨ãƒªã€‘æœ‰æ©Ÿãƒ»è‡ªç„¶é£Ÿå“ãƒ»ãƒ´ã‚£ãƒ¼ã‚¬ãƒ³ãƒ»ç„¡æ·»åŠ ãªã©å…¨æ–¹ä½ç¶²ç¾…
        const keywords = [
            'ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯', 
            'ORGANIC', 
            'æœ‰æ©Ÿ', 
            'è‡ªç„¶é£Ÿå“', 
            'ç„¡æ·»åŠ ', 
            'ãƒ´ã‚£ãƒ¼ã‚¬ãƒ³', 
            'VEGAN', 
            'ãƒã‚¯ãƒ­ãƒ“ã‚ªãƒ†ã‚£ãƒƒã‚¯', 
            'å¥åº·é£Ÿå“'
        ];
        const queryKeywords = keywords.join(' OR ');

        // Yahoo!ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒAPIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const url = `https://map.yahooapis.jp/search/local/V1/localSearch?appid=${appid}&lat=${center.lat}&lon=${center.lng}&dist=10&query=${encodeURIComponent(queryKeywords)}&results=50&output=json&callback=handleResponse`;

        const script = document.createElement('script');
        script.src = url;
        script.id = "api-script";
        // é€šä¿¡ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•
        script.onerror = () => stopScan("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã•ã€‚è¨­å®šã‚’ç¢ºèªã™ã‚‹ã•");
        document.body.appendChild(script);

        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã•
        setTimeout(() => {
            if(isScanning && markers.length === 0) {
                stopScan("ã¾ã å¿œç­”ãŒãªã„ã•ã€‚ã‚­ãƒ¼ã‚’ç¢ºèªã™ã¹ãã ã•");
            }
        }, 10000);
    }

    function stopScan(msg) {
        isScanning = false;
        document.getElementById('map').classList.remove('map-locked');
        document.getElementById('status').innerText = msg;
        document.getElementById('action-btn').innerText = "ğŸŒ¿ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã•";
        document.getElementById('action-btn').className = "btn scan-btn";
        if (searchCircle) { map.removeLayer(searchCircle); searchCircle = null; }
        const oldScript = document.getElementById('api-script');
        if (oldScript) oldScript.remove();
    }

    // APIã‹ã‚‰ã®å¿œç­”å‡¦ç†ã•
    window.handleResponse = function(data) {
        if (!isScanning) return;
        
        if (!data.Feature || data.Feature.length === 0) {
            stopScan("ã“ã“ã«ã¯åº—ãŒè¦‹å½“ãŸã‚‰ãªã„ã•");
            return;
        }

        data.Feature.forEach((f, i) => {
            const coords = f.Geometry.Coordinates.split(',');
            // ãƒãƒ¼å¤ªéƒãƒ”ãƒ³ã®ä½œæˆã•
            const mataroIcon = L.icon({
                iconUrl: 'mataro.jpg',
                className: 'mataro-pin',
                iconSize: [50, 50],
                iconAnchor: [25, 25],
                popupAnchor: [0, -25]
            });
            const m = L.marker([coords[1], coords[0]], {icon: mataroIcon}).addTo(map)
                .bindPopup(`<b>${f.Name}</b><br><a href="https://www.google.com/search?q=${f.Name}" target="_blank">Googleã§æ¤œç´¢ã•</a>`);
            markers.push(m);
        });
        document.getElementById('dog-msg-text').innerText = "è¦‹ã¤ã‘ãŸã•ï¼";
        stopScan(data.Feature.length + "ä»¶ã€è¦‹ã¤ã‹ã£ãŸãã†ã•ï¼");
    };
</script>
</body>
</html>

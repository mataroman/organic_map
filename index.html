<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Organic Map Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        #map { flex-grow: 1; width: 100vw; }
        .ui-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 400px; text-align: center;
        }
        #scan-btn {
            background: #2e7d32; color: white; border: none; padding: 18px;
            width: 100%; border-radius: 50px; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer;
        }
        #scan-btn:active { background: #1b5e20; transform: scale(0.95); }
        #status {
            margin-top: 10px; background: rgba(255,255,255,0.9);
            padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; display: inline-block;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div class="ui-panel">
    <button id="scan-btn" onclick="startScan()">ğŸŒ¿ ã“ã®ã‚¨ãƒªã‚¢ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
    <div id="status">æº–å‚™å®Œäº†</div>
</div>

<script>
    // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆæœ€åˆã¯æ—¥æœ¬å…¨ä½“ï¼‰
    const map = L.map('map').setView([35.68, 139.76], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let firstTime = true;

    function startScan() {
        const status = document.getElementById('status');
        
        if (firstTime) {
            status.innerText = "ç¾åœ¨åœ°ã‚’ç‰¹å®šä¸­...";
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                map.setView([lat, lon], 14);
                L.marker([lat, lon]).addTo(map).bindPopup("ã‚ãªãŸã®ç¾åœ¨åœ°").openPopup();
                firstTime = false;
                executeSearch(lat, lon);
            }, err => {
                status.innerText = "GPSã‚¨ãƒ©ãƒ¼: è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„";
                // GPSãŒãƒ€ãƒ¡ã§ã‚‚ã€ä»Šã®ä¸­å¿ƒåœ°ã§æ¤œç´¢ã‚’è©¦ã¿ã‚‹
                firstTime = false;
                const center = map.getCenter();
                executeSearch(center.lat, center.lng);
            });
        } else {
            const center = map.getCenter();
            executeSearch(center.lat, center.lng);
        }
    }

    function executeSearch(lat, lon) {
        const status = document.getElementById('status');
        status.innerText = "å‘¨è¾ºã®ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯åº—ã‚’æ¤œç´¢ä¸­...";

        // æ—¥æœ¬èªãƒ»è‹±èªä¸¡æ–¹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã€åŠå¾„5kmã‚’æ¤œç´¢
        const query = `[out:json][timeout:25];(node["shop"~"organic|health_food"](around:5000,${lat},${lon});node["name"~"æœ‰æ©Ÿ|è‡ªç„¶é£Ÿå“|ç”£ç›´|ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯"](around:5000,${lat},${lon}););out;`;
        const url = `https://overpass.kumi.systems/api/interpreter?data=${encodeURIComponent(query)}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (!data.elements || data.elements.length === 0) {
                    status.innerText = "ã“ã®ä»˜è¿‘ã«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
                    return;
                }
                status.innerText = `${data.elements.length}è»’ã®åº—èˆ—ã‚’ç™ºè¦‹ï¼`;
                
                data.elements.forEach(el => {
                    const name = el.tags.name || "è‡ªç„¶é£Ÿå“åº—";
                    const greenIcon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                    });

                    L.marker([el.lat, el.lon], {icon: greenIcon}).addTo(map)
                        .bindPopup(`<b>${name}</b><br><br><a href="https://www.google.com/maps/dir/?api=1&destination=${el.lat},${el.lon}" target="_blank" style="background:#f39c12;color:white;padding:8px 12px;text-decoration:none;border-radius:5px;display:inline-block;">ã“ã“ã¸è¡Œã(ãƒŠãƒ“)</a>`);
                });
            })
            .catch(err => {
                status.innerText = "ã‚µãƒ¼ãƒãƒ¼æ··é›‘ã€‚ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ãã ã•ã„ã€‚";
            });
    }
</script>
</body>
</html>

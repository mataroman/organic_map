<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Organic Hunter âœ¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root { --main-green: #2e7d32; --stop-red: #c62828; --bg-glass: rgba(255, 255, 255, 0.9); }
        body { margin: 0; padding: 0; height: 100dvh; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; overflow: hidden; background: #f0f0f0; }
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; transition: filter 0.4s; }
        .map-locked { filter: grayscale(0.8) blur(2px); pointer-events: none; }
        
        .crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; pointer-events: none; font-size: 35px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
        }

        /* ç”»é¢ä¸‹ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .ui { position: fixed; bottom: 30px; left: 0; right: 0; z-index: 3000; text-align: center; }
        .btn {
            color: white; border: none; padding: 18px 45px;
            border-radius: 50px; font-weight: bold; font-size: 1.2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            cursor: pointer; min-width: 240px; transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1); -webkit-appearance: none;
        }
        .scan-btn { background: linear-gradient(135deg, #43a047, #2e7d32); }
        .stop-btn { background: linear-gradient(135deg, #e53935, #c62828); }
        .btn:active { transform: scale(0.95); }

        /* é€²æ—ãƒãƒ¼ã®é«˜ç´šåŒ– */
        #progress-container {
            width: 70%; max-width: 250px; height: 6px; background: rgba(0,0,0,0.1);
            margin: 15px auto; border-radius: 10px; overflow: hidden; display: none;
        }
        #progress-bar { width: 0%; height: 100%; background: var(--main-green); transition: width 0.2s ease-out; }

        #status {
            background: var(--bg-glass); padding: 10px 25px; border-radius: 30px;
            font-size: 0.95rem; display: inline-block; font-weight: bold; color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5);
        }

        /* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ */
        .locate-btn {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            background: white; border: none; width: 50px; height: 50px; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 24px; cursor: pointer;
        }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è£…é£¾ */
        .popup-card { text-align: center; min-width: 200px; padding: 10px 0; }
        .link-btn {
            display: block; margin-top: 10px; padding: 12px; text-decoration: none;
            border-radius: 8px; font-weight: bold; font-size: 0.9rem; transition: background 0.2s;
        }
        .hp-btn { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .nav-btn { background: #2e7d32; color: white; }
    </style>
</head>
<body>

<button class="locate-btn" onclick="moveToCurrentLocation()">ğŸ“</button>
<div id="map"><div class="crosshair">âœ¨</div></div>

<div class="ui">
    <div id="status">å®å¡šã®ç¾å‘³ã—ã„åº—ã€æ¢ã™ã‚ˆï¼</div>
    <div id="progress-container"><div id="progress-bar"></div></div>
    <button id="action-btn" class="btn scan-btn" onclick="toggleScan()">ğŸŒ¿ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
</div>

<script>
    const appid = 'dj00aiZpPVhxNDZuMmNxTWtNayZzPWNvbnN1bWVyc2VjcmV0Jng9NTI-';
    let isScanning = false;
    let progressVal = 0;
    let pTimer;

    const map = L.map('map', { zoomControl: false }).setView([34.811, 135.341], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function moveToCurrentLocation() {
        navigator.geolocation.getCurrentPosition(pos => {
            map.flyTo([pos.coords.latitude, pos.coords.longitude], 15, { duration: 1.5 });
        });
    }
    moveToCurrentLocation();

    function toggleScan() {
        if (isScanning) { stopScan("ä¸­æ–­ã—ãŸã‚ˆ"); } else { startScan(); }
    }

    function startScan() {
        isScanning = true;
        map.dragging.disable(); map.touchZoom.disable();
        document.getElementById('map').classList.add('map-locked');

        const btn = document.getElementById('action-btn');
        const status = document.getElementById('status');
        const bar = document.getElementById('progress-bar');
        document.getElementById('progress-container').style.display = "block";

        btn.innerText = "ğŸ›‘ åœæ­¢ã™ã‚‹"; btn.className = "btn stop-btn";
        status.innerText = "ä¸€ç”Ÿæ‡¸å‘½ã€æ¢ã—ä¸­...";
        
        progressVal = 0;
        pTimer = setInterval(() => {
            if (progressVal < 98) {
                progressVal += (100 - progressVal) * 0.15;
                bar.style.width = progressVal + "%";
            }
        }, 150);

        const center = map.getCenter();
        const query = encodeURIComponent('ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ è‡ªç„¶é£Ÿå“ ç„¡æ·»åŠ  ç”£ç›´');
        const url = `https://map.yahooapis.jp/search/local/V1/localSearch?appid=${appid}&lat=${center.lat}&lon=${center.lng}&dist=3&query=${query}&output=json&results=30&callback=handleResponse`;

        const script = document.createElement('script');
        script.id = "yahoo-script"; script.src = url;
        document.body.appendChild(script);
    }

    function stopScan(msg) {
        isScanning = false; clearInterval(pTimer);
        map.dragging.enable(); map.touchZoom.enable();
        document.getElementById('map').classList.remove('map-locked');
        document.getElementById('progress-container').style.display = "none";
        
        const btn = document.getElementById('action-btn');
        btn.innerText = "ğŸŒ¿ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹"; btn.className = "btn scan-btn";
        document.getElementById('status').innerText = msg;

        const script = document.getElementById('yahoo-script');
        if (script) script.remove();
    }

    window.handleResponse = function(data) {
        if (!isScanning) return;
        
        // 100%ã«å¼¾ãé£›ã°ã™
        document.getElementById('progress-bar').style.width = "100%";
        document.getElementById('status').innerText = "è¦‹ã¤ã‘ãŸã‚ˆï¼åœ°å›³ã«æ›¸ãè¾¼ã¿ä¸­...";

        setTimeout(() => {
            if (!data.Feature || data.Feature.length === 0) {
                stopScan("ã“ã®è¾ºã«ã¯ãªã„ã¿ãŸã„...ğŸ˜¢");
                return;
            }

            data.Feature.forEach((f, i) => {
                setTimeout(() => {
                    const coords = f.Geometry.Coordinates.split(',');
                    const name = f.Name;
                    const siteUrl = f.Property.Detail.PcSiteUrl || `https://www.google.com/search?q=${encodeURIComponent(name)}`;

                    const icon = L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                    });

                    // è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå°‘ã—ãšã¤ãšã‚‰ã—ã¦è¡¨ç¤ºï¼‰
                    L.marker([coords[1], coords[0]], {icon: icon, bounceOnAdd: true}).addTo(map)
                        .bindPopup(`
                            <div class="popup-card">
                                <b style="color:#2e7d32; font-size:1.1rem;">${name}</b>
                                <a href="${siteUrl}" target="_blank" class="link-btn hp-btn">ğŸ” è©³ç´°ã‚’è¦‹ã‚‹</a>
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${coords[1]},${coords[0]}" target="_blank" class="link-btn nav-btn">ğŸš— ã“ã“ã¸è¡Œã</a>
                            </div>
                        `);
                }, i * 100); // 0.1ç§’ãšã¤ãšã‚‰ã—ã¦ãƒ”ãƒ³ã‚’é™ã‚‰ã›ã‚‹
            });

            setTimeout(() => stopScan(data.Feature.length + "ä»¶è¦‹ã¤ã‹ã£ãŸã‚ˆ âœ¨"), 500);
        }, 400);
    };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Organic Hunter âœ¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root { --main-green: #2e7d32; --stop-red: #c62828; }
        body { margin: 0; padding: 0; height: 100dvh; font-family: sans-serif; overflow: hidden; background: #000; }
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; transition: 0.3s; }
        .map-locked { opacity: 0.7; filter: brightness(0.8); pointer-events: none; }

        .dog-banner {
            position: fixed; top: 15px; left: 15px; z-index: 4000;
            background: white; padding: 5px; border-radius: 50px;
            display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 2px solid var(--main-green);
        }
        .dog-photo { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .dog-msg { padding: 0 15px 0 10px; font-weight: bold; font-size: 0.8rem; color: #333; }

        .ui { position: fixed; bottom: 30px; left: 0; right: 0; z-index: 3000; text-align: center; }
        .btn {
            color: white; border: none; padding: 18px 45px;
            border-radius: 50px; font-weight: bold; font-size: 1.2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            cursor: pointer; min-width: 240px;
        }
        .scan-btn { background: var(--main-green); }
        .stop-btn { background: var(--stop-red); }
        
        #progress-container {
            width: 70%; max-width: 250px; height: 8px; background: rgba(255,255,255,0.5);
            margin: 15px auto; border-radius: 10px; overflow: hidden; display: none;
        }
        #progress-bar { width: 0%; height: 100%; background: #fff; transition: width 0.1s linear; }

        #status {
            background: rgba(255,255,255,0.95); padding: 8px 20px;
            border-radius: 25px; font-size: 0.9rem; display: inline-block; font-weight: bold;
        }
        /* ãƒãƒ¼å¤ªéƒãƒ”ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .mataro-pin {
            width: 45px !important; height: 45px !important;
            border: 3px solid white; border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); object-fit: cover;
        }
    </style>
</head>
<body>

<div class="dog-banner">
    <img src="mataro.jpg" class="dog-photo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616408.png'">
    <div class="dog-msg">ãƒãƒ¼å¤ªéƒãŒã‚¯ãƒ³ã‚¯ãƒ³ã™ã‚‹ã®ã•ï¼</div>
</div>

<div id="map"></div>

<div class="ui">
    <div id="status">ãƒãƒ¼å¤ªéƒãŒæ¢ã—ã¦ãã‚Œã‚‹ã•</div>
    <div id="progress-container"><div id="progress-bar"></div></div>
    <button id="action-btn" class="btn scan-btn" onclick="toggleScan()">ğŸŒ¿ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
</div>

<script>
    // APIã‚­ãƒ¼ï¼ˆã‚‚ã—ã“ã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ã€Yahooã®ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶é™ã€ã‚’ç¢ºèªã—ã¦ã»ã—ã„ã•ï¼‰
    const appid = 'dmVyPTIwMjUwNyZpZD1YcTQ2bjJjcU1rJmhhc2g9TlRRNVpURTJZakEyTVRKbVl6TTVZUQ';
    let isScanning = false;
    let pTimer = null;
    let searchCircle = null;
    let markers = [];

    const map = L.map('map', { zoomControl: false }).setView([34.811, 135.341], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function toggleScan() { if (isScanning) { stopScan("ã‚„ã‚ã‚‹ã®ã•"); } else { startScan(); } }

    function startScan() {
        isScanning = true;
        // å¤ã„ãƒ”ãƒ³ã‚’æ¶ˆã™ã•
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        map.dragging.disable(); map.touchZoom.disable();
        document.getElementById('map').classList.add('map-locked');
        document.getElementById('progress-container').style.display = "block";
        const btn = document.getElementById('action-btn');
        const bar = document.getElementById('progress-bar');
        
        btn.innerText = "ğŸ›‘ æ­¢ã‚ã‚‹ã®ã•"; btn.className = "btn stop-btn";
        document.getElementById('status').innerText = "ãƒãƒ¼å¤ªéƒãŒæ¢ç´¢ä¸­ã•...";

        const center = map.getCenter();
        searchCircle = L.circle(center, {
            radius: 5000, color: '#2e7d32', fillColor: '#2e7d32', fillOpacity: 0.1, weight: 2
        }).addTo(map);

        bar.style.width = "0%";
        let pVal = 0;
        pTimer = setInterval(() => {
            pVal += 1;
            if(pVal <= 99) bar.style.width = pVal + "%";
        }, 100);

        // æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚ˆã‚Šå¼·åŠ›ãªã‚‚ã®ã«ã—ãŸãã†ã•
        const query = encodeURIComponent('ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ è‡ªç„¶é£Ÿå“');
        const url = `https://map.yahooapis.jp/search/local/V1/localSearch?appid=${appid}&lat=${center.lat}&lon=${center.lng}&dist=5&query=${query}&output=json&results=20&callback=handleResponse`;

        const script = document.createElement('script');
        script.id = "yahoo-script";
        script.src = url;
        script.onerror = () => stopScan("é€šä¿¡ã«å¤±æ•—ã—ãŸãã†ã•ã€‚é›»æ³¢ã‹è¨­å®šã‚’ç¢ºèªã—ã¦ãã‚Œã•");
        document.body.appendChild(script);
    }

    function stopScan(msg) {
        isScanning = false;
        clearInterval(pTimer);
        map.dragging.enable(); map.touchZoom.enable();
        document.getElementById('map').classList.remove('map-locked');
        document.getElementById('progress-container').style.display = "none";
        if (searchCircle) { map.removeLayer(searchCircle); searchCircle = null; }
        document.getElementById('action-btn').innerText = "ğŸŒ¿ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã•";
        document.getElementById('action-btn').className = "btn scan-btn";
        document.getElementById('status').innerText = msg;
        const script = document.getElementById('yahoo-script');
        if (script) script.remove();
    }

    window.handleResponse = function(data) {
        if (!isScanning) return;
        document.getElementById('progress-bar').style.width = "100%";

        if (!data.Feature || data.Feature.length === 0) {
            stopScan("ã“ã“ã«ã¯åº—ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãã†ã•...");
            return;
        }

        data.Feature.forEach((f, i) => {
            setTimeout(() => {
                const coords = f.Geometry.Coordinates.split(',');
                // ã€ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆã€‘ãƒãƒ¼å¤ªéƒã®é¡”ã‚’ãƒ”ãƒ³ã«ã™ã‚‹ã®ã•
                const mataroIcon = L.icon({
                    iconUrl: 'mataro.jpg',
                    className: 'mataro-pin',
                    iconSize: [45, 45],
                    iconAnchor: [22, 22],
                    popupAnchor: [0, -20]
                });

                const m = L.marker([coords[1], coords[0]], {icon: mataroIcon}).addTo(map)
                    .bindPopup(`<b>${f.Name}</b><br><a href="https://www.google.com/search?q=${f.Name}" target="_blank">è©³ç´°ã•</a>`);
                markers.push(m);
            }, i * 100);
        });
        setTimeout(() => stopScan(data.Feature.length + "ä»¶è¦‹ã¤ã‘ãŸã®ã•ï¼"), 1000);
    };
</script>
</body>
</html>

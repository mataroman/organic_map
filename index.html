<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Organic Hunter âœ¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root { --main-green: #2e7d32; }
        body { margin: 0; padding: 0; height: 100dvh; font-family: sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100%; position: absolute; }
        .crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; pointer-events: none; font-size: 32px; filter: drop-shadow(0 0 2px white);
        }
        .ui { position: fixed; bottom: 30px; left: 0; right: 0; z-index: 3000; text-align: center; }
        .scan-btn {
            background: var(--main-green); color: white; border: none; padding: 16px 40px;
            border-radius: 50px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer; -webkit-appearance: none;
        }
        #status {
            background: rgba(255,255,255,0.9); margin-top: 10px; padding: 6px 15px;
            border-radius: 20px; font-size: 0.85rem; display: inline-block; font-weight: bold;
        }
        .popup-card { text-align: center; padding: 5px; }
        .popup-card b { font-size: 1.1rem; color: var(--main-green); }
        .btn {
            display: block; margin-top: 8px; padding: 10px; text-decoration: none;
            border-radius: 5px; font-weight: bold; font-size: 0.9rem;
        }
        .hp-btn { background: #e3f2fd; color: #1976d2; }
        .nav-btn { background: #f39c12; color: white; }
    </style>
</head>
<body>

<div id="map"><div class="crosshair">âœ¨</div></div>
<div class="ui">
    <button class="scan-btn" onclick="yahooScan()">ğŸŒ¿ ã“ã®ã‚¨ãƒªã‚¢ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button><br>
    <div id="status">åœ°å›³ã‚’å‹•ã‹ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã­</div>
</div>

<script>
    // å…ˆã»ã©å–å¾—ã—ãŸIDï¼ˆãƒ‡ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ã®ã‚‚ã®ï¼‰ã‚’ã“ã“ã«ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ
    const appid = 'dj00aiZpPVhxNDZuMmNxTWtNayZzPWNvbnN1bWVyc2VjcmV0Jng9NTI-';

    // 1. åœ°å›³åˆæœŸåŒ–
    var map = L.map('map', { zoomControl: false }).setView([34.811, 135.341], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 2. ç¾åœ¨åœ°ã«ç§»å‹•
    navigator.geolocation.getCurrentPosition(pos => {
        map.flyTo([pos.coords.latitude, pos.coords.longitude], 15);
    });

    // 3. Yahoo! APIã‚¹ã‚­ãƒ£ãƒ³
    async function yahooScan() {
        const status = document.getElementById('status');
        const center = map.getCenter();
        status.innerText = "ã‚¹ã‚­ãƒ£ãƒ³ä¸­...";

        // CORSå›é¿ã®ãŸã‚ã€Yahooå…¬å¼ã®JSONPã¾ãŸã¯Proxyçš„ãªæ‰‹æ³•ãŒå¿…è¦ã§ã™ãŒã€
        // YOLP APIã®ä»•æ§˜ã«åˆã‚ã›ã€æœ€ã‚‚ç¢ºå®Ÿãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™
        const query = encodeURIComponent('ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ è‡ªç„¶é£Ÿå“ ç„¡æ·»åŠ  ç”£ç›´');
        const url = `https://map.yahooapis.jp/search/local/V1/localSearch?appid=${appid}&lat=${center.lat}&lon=${center.lng}&dist=3&query=${query}&output=json&results=20&callback=handleResponse`;

        // JSONPæ–¹å¼ã§å‘¼ã³å‡ºã—ï¼ˆCORSã‚¨ãƒ©ãƒ¼ã‚’ç‰©ç†çš„ã«å›é¿ã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æŠ€ã§ã™ï¼‰
        const script = document.createElement('script');
        script.src = url;
        document.body.appendChild(script);
        document.body.removeChild(script);
    }

    // 4. Yahooã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹é–¢æ•°
    window.handleResponse = function(data) {
        const status = document.getElementById('status');
        if (!data.Feature || data.Feature.length === 0) {
            status.innerText = "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸğŸ˜¢";
            return;
        }

        status.innerText = data.Count + "ä»¶ã®ã‚·ãƒ§ãƒƒãƒ—ã‚’ç™ºè¦‹ï¼";
        data.Feature.forEach(f => {
            const coords = f.Geometry.Coordinates.split(',');
            const lat = coords[1];
            const lon = coords[0];
            const name = f.Name;
            
            // Yahoo!ãŒæŒã£ã¦ã„ã‚‹å…¬å¼URLã€ãªã‘ã‚Œã°Googleæ¤œç´¢ã¸
            const siteUrl = f.Property.Detail.PcSiteUrl || `https://www.google.com/search?q=${encodeURIComponent(name)}`;

            const content = `
                <div class="popup-card">
                    <b>${name}</b>
                    <a href="${siteUrl}" target="_blank" class="btn hp-btn">ğŸŒ å…¬å¼ã‚µã‚¤ãƒˆãƒ»è©³ç´°</a>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="btn nav-btn">ğŸš— ã“ã“ã¸è¡Œãï¼ˆãƒŠãƒ“ï¼‰</a>
                </div>
            `;

            const icon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
            });

            L.marker([lat, lon], {icon: icon}).addTo(map).bindPopup(content);
        });
    };
</script>
</body>
</html>

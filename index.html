<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Organic Hunter âœ¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root { --main-green: #2e7d32; --stop-red: #c62828; --accent-blue: #1a73e8; }
        body { margin: 0; padding: 0; height: 100dvh; font-family: 'Helvetica Neue', Arial, sans-serif; background: #f0f2f0; overflow: hidden; }
        
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; }

        /* ãƒãƒ¼å¤ªéƒã®ãƒãƒŠãƒ¼ï¼ˆUIã®æ ¼ä¸Šã’ã•ï¼‰ */
        .dog-banner {
            position: fixed; top: 20px; left: 20px; z-index: 4000;
            background: white; padding: 6px; border-radius: 50px;
            display: flex; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
        }
        .dog-photo { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .dog-msg { padding: 0 18px 0 10px; font-weight: 600; font-size: 0.9rem; color: #2e7d32; min-width: 150px; }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .ui { position: fixed; bottom: 40px; left: 0; right: 0; z-index: 3000; text-align: center; }
        #status { 
            background: rgba(255,255,255,0.9); padding: 8px 24px; border-radius: 30px; 
            font-size: 0.85rem; display: inline-block; font-weight: bold; margin-bottom: 12px; 
            color: #444; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn { 
            color: white; border: none; padding: 16px 50px; border-radius: 50px; 
            font-weight: bold; font-size: 1.1rem; cursor: pointer; 
            min-width: 260px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .scan-btn { background: var(--main-green); }
        .stop-btn { background: var(--stop-red); }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæƒ…å ±ã‚’æ•´ç†ã—ãŸã•ï¼‰ */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 5px; }
        .popup-card { min-width: 180px; }
        .popup-name { font-weight: bold; font-size: 1.05rem; color: #333; display: block; margin-bottom: 4px; }
        .popup-address { font-size: 0.75rem; color: #666; display: block; margin-bottom: 10px; }
        .popup-link { 
            display: inline-block; background: var(--accent-blue); color: white; 
            padding: 6px 14px; border-radius: 6px; text-decoration: none; 
            font-size: 0.8rem; font-weight: bold;
        }

        .mataro-pin { width: 52px !important; height: 52px !important; border: 3px solid #fff; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="dog-banner">
    <img src="mataro.jpg" class="dog-photo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616408.png'">
    <div id="dog-msg-text" class="dog-msg">ä½•ã‹æ¢ã—ã«è¡Œãã•ï¼Ÿ</div>
</div>

<div id="map"></div>

<div class="ui">
    <div id="status">å‘¨è¾ºã®è‡ªç„¶ç’°å¢ƒã‚’ã‚µãƒ¼ãƒã™ã‚‹ã•</div><br>
    <button id="action-btn" class="btn scan-btn" onclick="toggleScan()">ğŸŒ¿ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã•</button>
</div>

<script>
    const appid = 'dmVyPTIwMjUwNyZpZD1YcTQ2bjJjcU1rJmhhc2g9TlRRNVpURTJZakEyTVRKbVl6TTVZUQ';
    
    let isScanning = false;
    let markers = [];
    let searchCircle = null;

    const map = L.map('map', { zoomControl: false }).setView([34.811, 135.341], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function toggleScan() {
        if (isScanning) {
            stopScan("ãƒªã‚µãƒ¼ãƒã‚’å®Œäº†ã—ãŸã•");
        } else {
            startScan();
        }
    }

    function startScan() {
        isScanning = true;
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        document.getElementById('dog-msg-text').innerText = "ã‚¯ãƒ³ã‚¯ãƒ³â€¦ã“ã®è¾ºã‚ŠãŒæ€ªã—ã„ã•";
        document.getElementById('status').innerText = "åºƒåŸŸã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œä¸­ã•...";
        document.getElementById('action-btn').innerText = "ğŸ›‘ åœæ­¢ã™ã‚‹ã•";
        document.getElementById('action-btn').className = "btn stop-btn";

        const center = map.getCenter();
        if (searchCircle) map.removeLayer(searchCircle);
        searchCircle = L.circle(center, { radius: 10000, color: '#2e7d32', fillOpacity: 0.1, weight: 1.5 }).addTo(map);

        // ã€æœ€å®‰å®šãƒ­ã‚¸ãƒƒã‚¯ã€‘ã‚·ãƒ³ãƒ—ãƒ«ä¸”ã¤åºƒç¯„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const url = `https://map.yahooapis.jp/search/local/V1/localSearch?appid=${appid}&lat=${center.lat}&lon=${center.lng}&dist=10&query=${encodeURIComponent('è‡ªç„¶é£Ÿå“')}&results=50&output=json&callback=handleResponse`;

        const script = document.createElement('script');
        script.src = url;
        script.id = "api-script";
        document.body.appendChild(script);

        setTimeout(() => {
            if(isScanning && markers.length === 0) {
                stopScan("å¿œç­”ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã•ã€‚å†è©¦è¡Œã—ã¦ãã‚Œã•");
            }
        }, 12000);
    }

    function stopScan(msg) {
        isScanning = false;
        document.getElementById('status').innerText = msg;
        document.getElementById('action-btn').innerText = "ğŸŒ¿ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ã•";
        document.getElementById('action-btn').className = "btn scan-btn";
        if (searchCircle) { map.removeLayer(searchCircle); searchCircle = null; }
        const oldScript = document.getElementById('api-script');
        if (oldScript) oldScript.remove();
    }

    window.handleResponse = function(data) {
        if (!isScanning) return;
        
        if (!data.Feature || data.Feature.length === 0) {
            stopScan("ã“ã®ã‚¨ãƒªã‚¢ã«ã¯è¦‹å½“ãŸã‚‰ãªã‹ã£ãŸã•");
            return;
        }

        data.Feature.forEach((f) => {
            const coords = f.Geometry.Coordinates.split(',');
            const m = L.marker([coords[1], coords[0]], {
                icon: L.icon({ iconUrl: 'mataro.jpg', className: 'mataro-pin', iconSize: [52, 52], iconAnchor: [26, 26] })
            }).addTo(map).bindPopup(`
                <div class="popup-card">
                    <span class="popup-name">${f.Name}</span>
                    <span class="popup-address">${f.Property.Address || ""}</span>
                    <a href="https://www.google.com/search?q=${encodeURIComponent(f.Name + ' ' + (f.Property.Address || ""))}" target="_blank" class="popup-link">è©³ç´°ãƒ»ãƒ«ãƒ¼ãƒˆã‚’ç¢ºèªã•</a>
                </div>
            `);
            markers.push(m);
        });

        document.getElementById('dog-msg-text').innerText = "ã„ã„åº—ã‚’è¦‹ã¤ã‘ãŸã•ï¼";
        stopScan(data.Feature.length + "ä»¶ã®ã‚¹ãƒãƒƒãƒˆã‚’æ•æ‰ã—ãŸãã†ã•ï¼");
    };
</script>
</body>
</html>

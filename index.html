<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Organic Hunter âœ¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root { --main-green: #2e7d32; --accent: #1a73e8; }
        body { margin: 0; padding: 0; height: 100dvh; font-family: sans-serif; background: #f8fcf8; overflow: hidden; }
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; }
        .dog-banner {
            position: fixed; top: 15px; left: 15px; z-index: 4000;
            background: white; padding: 6px; border-radius: 50px;
            display: flex; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 1px solid var(--main-green);
        }
        .dog-photo { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .dog-msg { padding: 0 15px 0 10px; font-weight: bold; font-size: 0.85rem; color: #2e7d32; min-width: 140px; }
        .ui { position: fixed; bottom: 35px; left: 0; right: 0; z-index: 3000; text-align: center; }
        #status { background: rgba(255,255,255,0.95); padding: 8px 22px; border-radius: 25px; font-size: 0.85rem; display: inline-block; font-weight: bold; margin-bottom: 10px; color: #333; }
        .btn { color: white; background: var(--main-green); border: none; padding: 16px 45px; border-radius: 50px; font-weight: bold; font-size: 1.1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .mataro-pin { width: 52px !important; height: 52px !important; border: 3px solid #fff; border-radius: 50%; object-fit: cover; box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="dog-banner">
    <img src="mataro.jpg" class="dog-photo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/616/616408.png'">
    <div id="dog-msg-text" class="dog-msg">ã‚¯ãƒ³ã‚¯ãƒ³â€¦æº–å‚™ã„ã„ã•ï¼Ÿ</div>
</div>

<div id="map"></div>

<div class="ui">
    <div id="status">å‘¨è¾ºã‚’ãƒ¯ã‚¤ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã•</div><br>
    <button class="btn" onclick="startScan()">ğŸŒ¿ ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã•</button>
</div>

<script>
    const appid = 'dmVyPTIwMjUwNyZpZD1YcTQ2bjJjcU1rJmhhc2g9TlRRNVpURTJZakEyTVRKbVl6TTVZUQ';
    const map = L.map('map', { zoomControl: false }).setView([34.811, 135.341], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];

    function startScan() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        document.getElementById('status').innerText = "åºƒåŸŸãƒ‡ãƒ¼ã‚¿ã‚’ç…§åˆä¸­ã•...";
        
        const center = map.getCenter();
        
        // ç¢ºå®Ÿã«ãƒ’ãƒƒãƒˆã™ã‚‹ã€Œè‡ªç„¶é£Ÿå“ã€ã§åºƒãæ‹¾ã„ã¤ã¤ã€æ¥­ç¨®(gc)ã‚‚æŒ‡å®šã•
        const url = `https://map.yahooapis.jp/search/local/V1/localSearch?appid=${appid}&lat=${center.lat}&lon=${center.lng}&dist=10&query=${encodeURIComponent('è‡ªç„¶é£Ÿå“')}&gc=0116&results=50&output=json&callback=handleResponse`;

        const script = document.createElement('script');
        script.src = url;
        script.id = "api-script";
        document.body.appendChild(script);
    }

    window.handleResponse = function(data) {
        if (!data.Feature || data.Feature.length === 0) {
            document.getElementById('status').innerText = "åº—èˆ—ãŒè¦‹å½“ãŸã‚‰ãªã„ã•";
            return;
        }

        let matchCount = 0;
        data.Feature.forEach((f) => {
            const name = f.Name;
            // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼šåº—åã«ã€Œã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ã€ã€Œæœ‰æ©Ÿã€ã€Œè‡ªç„¶ã€ãŒå«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’å¼·èª¿ã•
            const isPure = /ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯|æœ‰æ©Ÿ|ORGANIC|è‡ªç„¶é£Ÿå“/.test(name);
            
            const coords = f.Geometry.Coordinates.split(',');
            const m = L.marker([coords[1], coords[0]], {
                icon: L.icon({ 
                    iconUrl: 'mataro.jpg', 
                    className: 'mataro-pin', 
                    iconSize: isPure ? [60, 60] : [45, 45], // æœ¬å‘½ã¯å¤§ããè¡¨ç¤ºã•ï¼
                    iconAnchor: isPure ? [30, 30] : [22, 22]
                }),
                zIndexOffset: isPure ? 1000 : 0 // æœ¬å‘½ã‚’å‰é¢ã«å‡ºã™ã•
            }).addTo(map).bindPopup(`
                <b>${isPure ? 'â­ ' : ''}${name}</b><br>
                <small>${f.Property.Address || ""}</small><br>
                <a href="https://www.google.com/search?q=${encodeURIComponent(name + ' ' + (f.Property.Address || ""))}" target="_blank" style="color:blue; font-weight:bold;">è©³ç´°ã‚’è¦‹ã‚‹ã•</a>
            `);
            markers.push(m);
            matchCount++;
        });

        document.getElementById('status').innerText = matchCount + "ä»¶ã®å€™è£œã‚’è¦‹ã¤ã‘ãŸãã†ã•ï¼";
        document.getElementById('dog-msg-text').innerText = "å¤§ãã„ãƒ”ãƒ³ãŒãŠã™ã™ã‚ã•ï¼";
    };
</script>
</body>
</html>
